  <!-- üßë‚Äçü¶∞ PROFILE HEADER SECTION -->
  <section class="profile-header">
  <div class="container px-5" style="max-width: 800px;">
    <div class="text-white text-center">
      <h1 class="fw-bold mb-2" style="font-family: Poppins, sans-serif;">Hi <%= current_user.first_name %> üëã</h1>

      <div class="d-flex justify-content-center">
        <div class="avatar-container position-relative">
          <% if current_user.avatar.attached? %>
            <%= cl_image_tag current_user.avatar.key, class: "rounded-circle shadow-sm profile-avatar", alt: "Profile picture" %>
          <% else %>
            <div class="rounded-circle bg-light text-primary d-flex align-items-center justify-content-center shadow-sm profile-avatar-fallback">
              <%= current_user.first_name.first.upcase %>
            </div>
          <% end %>

          <div class="avatar-overlay d-flex align-items-center justify-content-center">
            <%= form_with model: current_user,
                          url: user_registration_path,
                          method: :patch,
                          local: true,
                          html: { multipart: true, class: "avatar-upload-form" } do |f| %>
              <%= f.file_field :avatar,
                    class: "d-none",
                    id: "avatar-upload",
                    onchange: "this.form.submit()" %>
              <label for="avatar-upload" class="btn btn-light m-0 p-2">
                <i class="fas fa-camera"></i>
              </label>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<div class="profile-container px-4 px-lg-5" style="max-width: 1400px;">
  <!-- üìä ENHANCED STATS SECTION -->
  <section class="stats-section py-5">
      <div class="container-fluid p-0">
        <h2 class="display-6 fw-bold mb-3 pakka-pink">Your Travel Story, Unpacked</h2>
        <p class="lead text-muted">See your travel footprint and plan your next chapter üß≥</p>
      </div>

      <div class="row g-4">
        <!-- Trip Counter Card -->
        <div class="col-md-4">
          <div class="stat-card stat-card-counter rounded-5 p-5 h-100">
            <div class="stat-icon mb-4">
              <div class="icon-circle bg-pakka-blue-light">
                <i class="fas fa-map-marked-alt text-pakka-blue"></i>
              </div>
            </div>
            <h3 class="h4 fw-bold mb-3">Trips Completed</h3>
            <div class="stat-number display-3 fw-bold text-pakka-blue">
              <%= @past_trips&.count || 0 %>
            </div>
            <div class="progress mt-4" style="height: 8px;">
              <div class="progress-bar bg-pakka-blue"
                  style="width: <%= [(@past_trips&.count || 0) * 2, 100].min %>%"></div>
            </div>
            <small class="text-muted mt-2 d-block">
              <%= @past_trips&.count ? "Keep exploring!" : "Your first adventure awaits!" %>
            </small>
          </div>
        </div>

        <!-- Destination Card -->
        <div class="col-md-4">
          <div class="stat-card stat-card-destination rounded-5 p-5 h-100">
            <div class="stat-icon mb-4">
              <div class="icon-circle bg-pakka-green-light">
                <i class="fas fa-heart text-pakka-green"></i>
              </div>
            </div>
            <h3 class="h4 fw-bold mb-3">Favorite Place</h3>
            <% if current_user.favorite_destination %>
              <div class="display-5 fw-bold text-pakka-green mb-3">
                <%= current_user.favorite_destination %>
              </div>
              <div class="mt-auto">
                <small class="text-muted">You've visited this destination <%= @favorite_destination_count || 0 %> times</small>
              </div>
            <% else %>
              <div class="mt-auto">
                <div class="display-6 text-muted my-4">
                  Where to next?
                </div>
                <%= link_to "Set favorite", new_trip_path, class: "btn btn-sm btn-home-primary-cta fs-6" %>
              </div>
            <% end %>
          </div>
        </div>

        <!-- Timeline Card -->
        <div class="col-md-4">
          <div class="stat-card stat-card-timeline rounded-5 p-5 h-100">
            <div class="stat-icon mb-4">
              <div class="icon-circle bg-pakka-yellow-light">
                <i class="fas fa-calendar-alt text-pakka-yellow"></i>
              </div>
            </div>
            <h3 class="h4 fw-bold mb-3">Travel Timeline</h3>
            <% if @past_trips&.any? %>
              <div class="timeline-wrapper">
                <div class="timeline-connector"></div>
                <div class="timeline-item">
                  <div class="timeline-dot bg-pakka-yellow"></div>
                  <div class="timeline-content">
                    <span class="timeline-label fw-900">Last Trip</span>
                    <div><%= @past_trips.first.created_at.strftime("%b %Y") %></div>
                  </div>
                </div>
                <% if @past_trips.size > 1 %>
                  <div class="timeline-item">
                    <div class="timeline-dot bg-pakka-blue"></div>
                    <div class="timeline-content">
                      <span class="timeline-label fw-900">First Trip</span>
                      <div><%= @past_trips.last.created_at.strftime("%b %Y") %></div>
                    </div>
                  </div>
                <% end %>
              </div>
              <small class="text-muted mt-3 d-block">
                <% if @past_trips.size > 1 %>
                  <% days_between = (@past_trips.first.created_at.to_date - @past_trips.last.created_at.to_date).to_i %>
                  <% years = days_between / 365 %>
                  <% months = ((days_between % 365) / 30.44).round %> <!-- 30.44 = average days/month -->

                  <%= @past_trips.size %> trips over
                  <% if years > 0 %>
                    <%= years %> <%= 'year'.pluralize(years) %>
                    <% if months > 0 %>and <%= months %> <%= 'month'.pluralize(months) %><% end %>
                  <% else %>
                    <%= months %> <%= 'month'.pluralize(months) %>
                  <% end %>
                <% else %>
                  <%= @past_trips.size %> trip (just started)
                <% end %>
              </small>
            <% else %>
              <div class="display-6 text-muted my-4">
                No trips yet
              </div>
              <%= link_to "Plan your first trip", new_trip_path, class: "btn btn-sm btn-pakka-pink" %>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- üß≥ Packing Essentials Section -->
  <section class="packing-section py-5 bg-blue">
    <div class="container px-4 px-lg-5" style="max-width: 1400px;">
      <div class="container-fluid p-0">
        <div class="mb-5">
          <h2 class="display-6 fw-bold mb-3 white" style="font-family: 'Poppins', sans-serif;">Your Always-Pack List</h2>
          <p class="lead white">Phone charger? Passport? These essentials auto-load into every trip checklist ‚ú®</p>
        </div>
      </div>

      <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
        <div class="card-body p-0">

          <!-- Add Item Form -->
          <div class="add-item-card bg-white rounded-4 p-4 mb-2 shadow-sm">
            <h3 class="fw-bold mb-3 #FFEC59 important;">Add New Essential</h3>
            <%= form_with model: @item, url: items_path, local: true, class: "add-item-form" do |f| %>
              <div class="row g-3 align-items-end">
                <div class="col-md-6">
                  <%= f.label :name, "Add custom item", class: "form-label fw-semibold small text-uppercase text-muted" %>
                  <%= f.text_field :name, class: "form-control form-control-lg border-1 py-2 fs-6", style: "border-radius: 10px;", placeholder: "e.g. Passport, Charger, Swimsuit" %>
                </div>
                <div class="col-md-5">
                  <%= f.label :category, "Select item category", class: "form-label fw-semibold small text-uppercase text-muted" %>
                  <%= f.select :category, Item::CATEGORIES.map { |cat| [cat.humanize, cat] },
                      { prompt: "Select a category" },
                      { class: "form-select form-select-lg border-1 py-2 fs-6", style: "border-radius: 10px;" } %>
                </div>
                <div class="col-md-1">
                  <%= f.submit "Add", class: "btn btn-pakka-green btn-lg w-100 py-2 fs-6", style: "border-radius: 10px;" %>
                </div>
              </div>
            <% end %>
          </div>

          <!-- Checklist Items -->
          <div class="essentials-container p-4">
            <% if @items.any? %>
              <% grouped_items = @items.group_by { |item| item.category } %>

              <% grouped_items.each do |category, items| %>
                <div class="category-group mb-4">
                  <!-- Category header -->
                  <div class="category-header d-flex align-items-center ps-3 py-3 bg-white mt-2 mb-1" style="border-top-left-radius: 10px; border-top-right-radius: 10px;">
                    <i class="fas fa-folder me-2" style="color: #fb7d93 !important;"></i>
                    <h5 class="mb-0" style="color: #fb7d93 !important;"><%= category.humanize %></h5>
                  </div>

                  <ul class="list-group list-group-flush overflow-hidden">
                    <% items.each do |item| %>
                      <li class="list-group-item d-flex align-items-center px-3 py-1 mt-1" id="item_<%= item.id %>">
                        <div class="form-check flex-grow-1" data-controller="inline-edit" data-inline-edit-item-id-value="<%= item.id %>">
                          <!-- Display version -->
                          <div data-inline-edit-target="display" class="d-flex align-items-center">
                            <label class="form-check-label flex-grow-1">
                              <span class="checklist-text">
                                <%= item.name.humanize || "Unnamed Item" %> (<%= item.category.humanize %>)
                              </span>
                            </label>

                            <div class="d-flex align-items-center action-buttons">
                              <!-- Edit button -->
                              <button type="button"
                                      class="btn btn-sm btn-outline-primary ms-2"
                                      style="font-family: 'DM Sans', sans-serif; border-radius: 10px;"
                                      data-action="click->inline-edit#showForm"
                                      data-inline-edit-target="editButton"
                                      aria-label="Edit item">
                                <i class="fas fa-pen"></i>
                              </button>

                              <!-- Delete button -->
                              <%= button_to item_path(item), method: :delete, class: "btn btn-sm btn-outline-icon-danger ms-2", style: "border-radius: 10px", data: { target: "inline-edit.deleteButton", confirm: "Are you sure?" } do %>
                                <i class="fas fa-trash-alt"></i>
                              <% end %>
                            </div>
                          </div>

                          <!-- Inline-edit form -->
                          <div data-inline-edit-target="form" class="d-none">
                            <%= render "items/edit", item: item %>
                          </div>
                        </div>
                      </li>
                    <% end %>
                  </ul>
                </div>
              <% end %>
            <% else %>
              <div class="empty-state text-center p-5 bg-pakka-light rounded-3">
                <i class="fas fa-suitcase text-muted fa-2x mb-3"></i>
                <p class="text-muted mb-0">Your essential packing list is empty</p>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- üèÜ TRAVEL MILESTONES SECTION -->
  <section class="milestones-section py-5 bg-pakka-light">
    <div class="container px-4 px-lg-5" style="max-width: 1400px;">
      <div class="container-fluid p-0">
        <h2 class="display-6 fw-bold mb-3 pakka-yellow">Level Up Your Explorations</h2>
        <p class="lead text-muted">Unlock badges from Packing Newbie to World Wanderer üó∫Ô∏è</p>
      </div>

      <div class="row g-4">
        <!-- Milestones -->
        <div class="col-6 col-md-4 col-lg-3">
          <div class="milestone-card <%= @past_trips&.count.to_i >= 1 ? 'unlocked' : 'locked' %>">
            <div class="milestone-icon">
              <i class="fas fa-<%= @past_trips&.count.to_i >= 1 ? 'check-circle' : 'lock' %>"></i>
            </div>
            <h4>First Adventure</h4>
            <p>Complete your first trip</p>
            <div class="progress">
              <div class="progress-bar" style="width: <%= @past_trips&.count.to_i >= 1 ? 100 : 0 %>%"></div>
            </div>
          </div>
        </div>

        <div class="col-6 col-md-4 col-lg-3">
          <div class="milestone-card <%= @past_trips&.count.to_i >= 5 ? 'unlocked' : 'locked' %>">
            <div class="milestone-icon">
              <i class="fas fa-<%= @past_trips&.count.to_i >= 5 ? 'globe-americas' : 'lock' %>"></i>
            </div>
            <h4>World Explorer</h4>
            <p>Complete 5 trips</p>
            <div class="progress">
              <div class="progress-bar" style="width: <%= [(@past_trips&.count.to_i / 5.0 * 100), 100].min %>%"></div>
            </div>
          </div>
        </div>

        <div class="col-6 col-md-4 col-lg-3">
          <div class="milestone-card <%= @visited_countries&.count.to_i >= 3 ? 'unlocked' : 'locked' %>">
            <div class="milestone-icon">
              <i class="fas fa-<%= @visited_countries&.count.to_i >= 3 ? 'passport' : 'lock' %>"></i>
            </div>
            <h4>Multi-Country</h4>
            <p>Visit 3 different countries</p>
            <div class="progress">
              <div class="progress-bar" style="width: <%= [(@visited_countries&.count.to_i / 3.0 * 100), 100].min %>%"></div>
            </div>
          </div>
        </div>

        <div class="col-6 col-md-4 col-lg-3">
          <div class="milestone-card <%= @longest_trip_duration.to_i >= 14 ? 'unlocked' : 'locked' %>">
            <div class="milestone-icon">
              <i class="fas fa-<%= @longest_trip_duration.to_i >= 14 ? 'umbrella-beach' : 'lock' %>"></i>
            </div>
            <h4>Long Vacation</h4>
            <p>Take a 2+ week trip</p>
            <div class="progress">
              <div class="progress-bar" style="width: <%= [(@longest_trip_duration.to_i / 14.0 * 100), 100].min %>%"></div>
            </div>
          </div>
        </div>
      </div>


      <!-- Extra Milestones for the Future
      <div class="text-center mt-5">
        <%= link_to "View all milestones", profile_path, class: "btn btn-pakka-blue" %>
      </div>
      -->

    </div>
  </section>
</div>
